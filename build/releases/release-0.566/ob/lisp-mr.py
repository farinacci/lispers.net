# -----------------------------------------------------------------------------
#             
# Copyright 2013-2019 lispers.net - Dino Farinacci <farinacci@gmail.com>
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#     http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.    
# 
# -----------------------------------------------------------------------------
#
# lisp-mr.py
#
# This file performs LISP Map-Resolver functionality.
# 
# -----------------------------------------------------------------------------
from __future__ import division
from builtins import str
from builtins import range
import lisp
import lispconfig
import threading
import select
if 64 - 64: i11iIiiIii
if 65 - 65: O0 / iIii1I11I1II1 % OoooooooOO - i1IIi
if 73 - 73: II111iiii
if 22 - 22: I1IiiI * Oo0Ooo / OoO0O00 . OoOoOO00 . o0oOOo0O0Ooo / I1ii11iIi11i
if 48 - 48: oO0o / OOooOOo / I11i / Ii1I
if 48 - 48: iII111i % IiII + I1Ii111 / ooOoO0o * Ii1I
i1I1ii1II1iII = [ None , None , None ]
oooO0oo0oOOOO = None
O0oO = None
o0oO0 = None
oo00 = { }
o00 = None
Oo0oO0ooo = lisp . lisp_get_ephemeral_port ( )
if 56 - 56: I11i - i1IIi
if 64 - 64: I1Ii111 + iII111i
if 10 - 10: i11iIiiIii / oO0o % II111iiii
if 75 - 75: i11iIiiIii + IiII . o0oOOo0O0Ooo * iII111i
if 59 - 59: iIii1I11I1II1
if 31 - 31: IiII % i1IIi * iIii1I11I1II1 / IiII % oO0o + OoooooooOO
if 93 - 93: iII111i * i11iIiiIii * I1IiiI % iII111i * iII111i * II111iiii
if 79 - 79: IiII
if 86 - 86: OoOoOO00 % I1IiiI
def oo ( ) :
 lisp . lisp_referral_cache = lisp . lisp_cache ( )
 return
 if 33 - 33: II111iiii * Oo0Ooo - o0oOOo0O0Ooo * iIii1I11I1II1 * OoooooooOO * ooOoO0o
 if 27 - 27: OoO0O00
 if 73 - 73: o0oOOo0O0Ooo - Oo0Ooo
 if 58 - 58: i11iIiiIii % I1Ii111
 if 54 - 54: OOooOOo % O0 + I1IiiI - iII111i / I11i
 if 31 - 31: OoO0O00 + II111iiii
 if 13 - 13: OOooOOo * oO0o * I1IiiI
def oOOOO ( kv_pair ) :
 global oo00
 if 45 - 45: I1Ii111 + Ii1I
 if 17 - 17: o0oOOo0O0Ooo
 if 64 - 64: Ii1I % i1IIi % OoooooooOO
 if 3 - 3: iII111i + O0
 I1Ii = lisp . lisp_ddt_root ( )
 if 66 - 66: Ii1I
 if 78 - 78: OoO0O00
 if 18 - 18: O0 - iII111i / iII111i + ooOoO0o % ooOoO0o - IiII
 if 62 - 62: iII111i - IiII - OoOoOO00 % i1IIi / oO0o
 OoooooOoo = lisp . lisp_referral ( )
 if 70 - 70: OoO0O00 . OoO0O00 - OoO0O00 / I1ii11iIi11i * OOooOOo
 if 86 - 86: i11iIiiIii + Ii1I + ooOoO0o * I11i + o0oOOo0O0Ooo
 if 61 - 61: OoO0O00 / i11iIiiIii
 if 34 - 34: OoooooooOO + iIii1I11I1II1 + i11iIiiIii - I1ii11iIi11i + i11iIiiIii
 for ooOoo0O in list ( kv_pair . keys ( ) ) :
  if ( ooOoo0O == "address" ) :
   OooO0 = kv_pair [ ooOoo0O ]
   I1Ii . root_address . store_address ( OooO0 )
   if 35 - 35: OOooOOo % I1Ii111 % i11iIiiIii / OoooooooOO
  if ( ooOoo0O == "public-key" ) :
   Ii11iI1i = kv_pair [ ooOoo0O ]
   I1Ii . public_key = Ii11iI1i
   if 82 - 82: i11iIiiIii . OOooOOo / Oo0Ooo * O0 % oO0o % iIii1I11I1II1
  if ( ooOoo0O == "priority" ) :
   Ii11iI1i = kv_pair [ ooOoo0O ]
   I1Ii . priority = Ii11iI1i
   if 78 - 78: iIii1I11I1II1 - Ii1I * OoO0O00 + o0oOOo0O0Ooo + iII111i + iII111i
  if ( ooOoo0O == "weight" ) :
   Ii11iI1i = kv_pair [ ooOoo0O ]
   I1Ii . weight = Ii11iI1i
   if 11 - 11: iII111i - OoO0O00 % ooOoO0o % iII111i / OoOoOO00 - OoO0O00
   if 74 - 74: iII111i * O0
   if 89 - 89: oO0o + Oo0Ooo
   if 3 - 3: i1IIi / I1IiiI % I11i * i11iIiiIii / O0 * I11i
   if 49 - 49: oO0o % Ii1I + i1IIi . I1IiiI % I1ii11iIi11i
   if 48 - 48: I11i + I11i / II111iiii / iIii1I11I1II1
 oo00 [ OooO0 ] = I1Ii
 if 20 - 20: o0oOOo0O0Ooo
 if 77 - 77: OoOoOO00 / I11i
 if 98 - 98: iIii1I11I1II1 / i1IIi / i11iIiiIii / o0oOOo0O0Ooo
 if 28 - 28: OOooOOo - IiII . IiII + OoOoOO00 - OoooooooOO + O0
 if 95 - 95: OoO0O00 % oO0o . O0
 if 15 - 15: ooOoO0o / Ii1I . Ii1I - i1IIi
 for I1Ii in list ( oo00 . values ( ) ) :
  o00oOO0 = lisp . lisp_referral_node ( )
  o00oOO0 . referral_address = I1Ii . root_address
  o00oOO0 . priority = I1Ii . priority
  o00oOO0 . weight = I1Ii . weight
  OooO0 = o00oOO0 . referral_address . print_address ( )
  OoooooOoo . referral_set [ OooO0 ] = o00oOO0
  if 95 - 95: OOooOOo / OoooooooOO
 OoooooOoo . eid . afi = lisp . LISP_AFI_ULTIMATE_ROOT
 if 18 - 18: i11iIiiIii
 if 46 - 46: i1IIi / I11i % OOooOOo + I1Ii111
 if 79 - 79: I1Ii111 - o0oOOo0O0Ooo + I1Ii111 - iII111i
 if 8 - 8: I1IiiI
 OoooooOoo . add_cache ( )
 return
 if 75 - 75: iIii1I11I1II1 / OOooOOo % o0oOOo0O0Ooo * OoOoOO00
 if 9 - 9: OoO0O00
 if 33 - 33: ooOoO0o . iII111i
 if 58 - 58: OOooOOo * i11iIiiIii / OoOoOO00 % I1Ii111 - I1ii11iIi11i / oO0o
 if 50 - 50: I1IiiI
 if 34 - 34: I1IiiI * II111iiii % iII111i * OoOoOO00 - I1IiiI
 if 33 - 33: o0oOOo0O0Ooo + OOooOOo * OoO0O00 - Oo0Ooo / oO0o % Ii1I
def II1i1IiiIIi11 ( kv_pair ) :
 if 47 - 47: iII111i
 Ii11iII1 = [ ]
 if ( lispconfig . lisp_clause_syntax_error ( kv_pair , "eid-prefix" ,
 "prefix" ) ) : return
 for Oo0O0O0ooO0O in range ( len ( kv_pair [ "eid-prefix" ] ) ) :
  OoooooOoo = lisp . lisp_referral ( )
  Ii11iII1 . append ( OoooooOoo )
  if 15 - 15: I1ii11iIi11i + OoOoOO00 - OoooooooOO / OOooOOo
  if 58 - 58: i11iIiiIii % I11i
 OO00Oo = [ ]
 if ( lispconfig . lisp_clause_syntax_error ( kv_pair , "address" ,
 "referral" ) ) : return
 for Oo0O0O0ooO0O in range ( len ( kv_pair [ "address" ] ) ) :
  O0OOO0OOoO0O = lisp . lisp_referral_node ( )
  OO00Oo . append ( O0OOO0OOoO0O )
  if 70 - 70: IiII * Oo0Ooo * I11i / Ii1I
  if 88 - 88: O0
 for ooOoo0O in list ( kv_pair . keys ( ) ) :
  Ii11iI1i = kv_pair [ ooOoo0O ]
  if ( ooOoo0O == "instance-id" ) :
   for Oo0O0O0ooO0O in range ( len ( Ii11iII1 ) ) :
    OoooooOoo = Ii11iII1 [ Oo0O0O0ooO0O ]
    O0OoO0O00o0oO = Ii11iI1i [ Oo0O0O0ooO0O ]
    if ( O0OoO0O00o0oO == "" ) : O0OoO0O00o0oO = "0"
    OoooooOoo . eid . instance_id = int ( O0OoO0O00o0oO )
    OoooooOoo . group . instance_id = int ( O0OoO0O00o0oO )
    if 15 - 15: Ii1I - O0 / oO0o * i1IIi
    if 92 - 92: OoOoOO00
  if ( ooOoo0O == "eid-prefix" ) :
   for Oo0O0O0ooO0O in range ( len ( Ii11iII1 ) ) :
    OoooooOoo = Ii11iII1 [ Oo0O0O0ooO0O ]
    O0OoO0O00o0oO = Ii11iI1i [ Oo0O0O0ooO0O ]
    if ( O0OoO0O00o0oO != "" ) : OoooooOoo . eid . store_prefix ( O0OoO0O00o0oO )
    if 26 - 26: iII111i . I1Ii111
    if 68 - 68: OoO0O00
  if ( ooOoo0O == "group-prefix" ) :
   for Oo0O0O0ooO0O in range ( len ( Ii11iII1 ) ) :
    OoooooOoo = Ii11iII1 [ Oo0O0O0ooO0O ]
    O0OoO0O00o0oO = Ii11iI1i [ Oo0O0O0ooO0O ]
    if ( O0OoO0O00o0oO != "" ) : OoooooOoo . group . store_prefix ( O0OoO0O00o0oO )
    if 35 - 35: OoO0O00 - iII111i / Oo0Ooo / OoOoOO00
    if 24 - 24: ooOoO0o - ooOoO0o / II111iiii - I1ii11iIi11i
    if 69 - 69: oO0o . I1Ii111 + Ii1I / Oo0Ooo - oO0o
  if ( ooOoo0O == "priority" ) :
   for Oo0O0O0ooO0O in range ( len ( OO00Oo ) ) :
    O0OOO0OOoO0O = OO00Oo [ Oo0O0O0ooO0O ]
    O0OoO0O00o0oO = Ii11iI1i [ Oo0O0O0ooO0O ]
    if ( O0OoO0O00o0oO == "" ) : O0OoO0O00o0oO = "0"
    O0OOO0OOoO0O . priority = int ( O0OoO0O00o0oO )
    if 63 - 63: OOooOOo % oO0o * oO0o * OoO0O00 / I1ii11iIi11i
    if 74 - 74: II111iiii
  if ( ooOoo0O == "weight" ) :
   for Oo0O0O0ooO0O in range ( len ( OO00Oo ) ) :
    O0OOO0OOoO0O = OO00Oo [ Oo0O0O0ooO0O ]
    O0OoO0O00o0oO = Ii11iI1i [ Oo0O0O0ooO0O ]
    if ( O0OoO0O00o0oO == "" ) : O0OoO0O00o0oO = "0"
    O0OOO0OOoO0O . weight = int ( O0OoO0O00o0oO )
    if 75 - 75: o0oOOo0O0Ooo . ooOoO0o
    if 54 - 54: II111iiii % OoOoOO00 % I11i % iIii1I11I1II1 + iIii1I11I1II1 * ooOoO0o
  if ( ooOoo0O == "address" ) :
   for Oo0O0O0ooO0O in range ( len ( OO00Oo ) ) :
    O0OOO0OOoO0O = OO00Oo [ Oo0O0O0ooO0O ]
    O0OoO0O00o0oO = Ii11iI1i [ Oo0O0O0ooO0O ]
    if ( O0OoO0O00o0oO != "" ) : O0OOO0OOoO0O . referral_address . store_address ( O0OoO0O00o0oO )
    if 87 - 87: ooOoO0o * Oo0Ooo % i11iIiiIii % OoOoOO00 - OOooOOo
    if 68 - 68: I1Ii111 % i1IIi . IiII . I1ii11iIi11i
    if 92 - 92: iII111i . I1Ii111
    if 31 - 31: I1Ii111 . OoOoOO00 / O0
    if 89 - 89: OoOoOO00
    if 68 - 68: OoO0O00 * OoooooooOO % O0 + OoO0O00 + ooOoO0o
    if 4 - 4: ooOoO0o + O0 * OOooOOo
 for OoooooOoo in Ii11iII1 :
  for O0OOO0OOoO0O in OO00Oo :
   OooO0 = O0OOO0OOoO0O . referral_address . print_address ( )
   OoooooOoo . referral_set [ OooO0 ] = O0OOO0OOoO0O
   if 55 - 55: Oo0Ooo + iIii1I11I1II1 / OoOoOO00 * oO0o - i11iIiiIii - Ii1I
  OoooooOoo . add_cache ( )
  if 25 - 25: I1ii11iIi11i
 return
 if 7 - 7: i1IIi / I1IiiI * I1Ii111 . IiII . iIii1I11I1II1
 if 13 - 13: OOooOOo / i11iIiiIii
 if 2 - 2: I1IiiI / O0 / o0oOOo0O0Ooo % OoOoOO00 % Ii1I
 if 52 - 52: o0oOOo0O0Ooo
 if 95 - 95: Ii1I
 if 87 - 87: ooOoO0o + OoOoOO00 . OOooOOo + OoOoOO00
 if 91 - 91: O0
def oOOo0 ( ref , output ) :
 if 54 - 54: O0 - IiII % OOooOOo
 OOoO = lisp . lisp_print_elapsed ( ref . uptime )
 iII = lisp . lisp_print_future ( ref . expires )
 ii1ii11IIIiiI = ref . print_eid_tuple ( )
 if 67 - 67: I11i * oO0o * I1ii11iIi11i + OOooOOo / i1IIi
 I1I111 = "configured" if ( ref . referral_source . not_set ( ) ) else ref . referral_source . print_address_no_iid ( )
 if 82 - 82: i11iIiiIii - iII111i * OoooooooOO / I11i
 if 31 - 31: IiII . OoO0O00 - iIii1I11I1II1
 ooOOO00Ooo = "--"
 if ( ref . eid . is_ultimate_root ( ) ) :
  IiIIIi1iIi = "root"
 elif ( I1I111 == "configured" ) :
  IiIIIi1iIi = "any"
 else :
  IiIIIi1iIi = ref . print_referral_type ( )
  if ( ref . is_referral_negative ( ) ) :
   IiIIIi1iIi = lisp . red ( IiIIIi1iIi , True )
   if 68 - 68: i11iIiiIii % I1ii11iIi11i + i11iIiiIii
  ooOOO00Ooo = "{}<br>{}" . format ( iII , str ( ref . referral_ttl / 60 ) )
  if 31 - 31: II111iiii . I1IiiI
  if 1 - 1: Oo0Ooo / o0oOOo0O0Ooo % iII111i * IiII . i11iIiiIii
 if ( len ( ref . referral_set ) == 0 ) :
  output += lispconfig . lisp_table_row ( ii1ii11IIIiiI , OOoO , ooOOO00Ooo ,
 IiIIIi1iIi , I1I111 , "--" , "--" , "--" )
  if 2 - 2: I1ii11iIi11i * I11i - iIii1I11I1II1 + I1IiiI . oO0o % iII111i
  if 92 - 92: iII111i
 for O0OOO0OOoO0O in list ( ref . referral_set . values ( ) ) :
  IIiIiiIi = O0OOO0OOoO0O . referral_address . print_address_no_iid ( )
  IIiIiiIi += "<br>up" if O0OOO0OOoO0O . updown else "<br>down"
  if 51 - 51: I11i + iII111i % iIii1I11I1II1 / oO0o / OOooOOo % OoooooooOO
  output += lispconfig . lisp_table_row ( ii1ii11IIIiiI , OOoO , ooOOO00Ooo ,
 IiIIIi1iIi , I1I111 , IIiIiiIi , str ( O0OOO0OOoO0O . priority ) + "<br>" +
 str ( O0OOO0OOoO0O . weight ) , str ( O0OOO0OOoO0O . map_requests_sent ) + "<br>" +
 str ( O0OOO0OOoO0O . no_responses ) )
  if 78 - 78: Ii1I % I1Ii111 + I1ii11iIi11i
  if ( ii1ii11IIIiiI != "" ) :
   ii1ii11IIIiiI = ""
   OOoO = ""
   ooOOO00Ooo = ""
   I1I111 = ""
   IiIIIi1iIi = ""
   if 64 - 64: oO0o * O0 . I1IiiI + II111iiii
   if 6 - 6: OoOoOO00 / iII111i . IiII . IiII
 return ( [ True , output ] )
 if 62 - 62: I1ii11iIi11i + IiII % iII111i + OOooOOo
 if 33 - 33: O0 . IiII . I1IiiI
 if 72 - 72: i1IIi / OoO0O00 + OoooooooOO - Oo0Ooo
 if 29 - 29: I1ii11iIi11i + oO0o % O0
 if 10 - 10: I11i / I1Ii111 - I1IiiI * iIii1I11I1II1 - I1IiiI
 if 97 - 97: I1ii11iIi11i + I1IiiI * Ii1I + OOooOOo % iII111i
 if 74 - 74: oO0o - Oo0Ooo + OoooooooOO + I1Ii111 / OoOoOO00
 if 23 - 23: O0
def o00oO0oOo00 ( ref , output ) :
 if 81 - 81: OoO0O00
 if 42 - 42: OoO0O00 / I11i / o0oOOo0O0Ooo + iII111i / OoOoOO00
 if 84 - 84: ooOoO0o * II111iiii + Oo0Ooo
 if 53 - 53: iII111i % II111iiii . IiII - iIii1I11I1II1 - IiII * II111iiii
 if ( ref . group . is_null ( ) ) : return ( oOOo0 ( ref , output ) )
 if 77 - 77: iIii1I11I1II1 * OoO0O00
 if ( ref . source_cache == None ) : return ( [ True , output ] )
 if 95 - 95: I1IiiI + i11iIiiIii
 if 6 - 6: ooOoO0o / i11iIiiIii + iII111i * oO0o
 if 80 - 80: II111iiii
 if 83 - 83: I11i . i11iIiiIii + II111iiii . o0oOOo0O0Ooo * I11i
 if 53 - 53: II111iiii
 output = ref . source_cache . walk_cache ( oOOo0 , output )
 return ( [ True , output ] )
 if 31 - 31: OoO0O00
 if 80 - 80: I1Ii111 . i11iIiiIii - o0oOOo0O0Ooo
 if 25 - 25: OoO0O00
 if 62 - 62: OOooOOo + O0
 if 98 - 98: o0oOOo0O0Ooo
 if 51 - 51: Oo0Ooo - oO0o + II111iiii * Ii1I . I11i + oO0o
 if 78 - 78: i11iIiiIii / iII111i - Ii1I / OOooOOo + oO0o
def oOoooo0O0Oo ( eid_str ) :
 o00ooO , OO0OO0O00oO0 , oO , I1Ii1I1 = lispconfig . lisp_get_lookup_string ( eid_str )
 if 28 - 28: O0 * Oo0Ooo - OOooOOo % iIii1I11I1II1 * Ii1I - i11iIiiIii
 if 7 - 7: Oo0Ooo + oO0o - I1Ii111 % Ii1I + I1ii11iIi11i
 ooo0OOOoo = "<br>"
 if 45 - 45: I1Ii111 / iIii1I11I1II1 + OoOoOO00 * OoO0O00 * OOooOOo . iII111i
 iI = lisp . lisp_referral_cache_lookup ( o00ooO , oO , OO0OO0O00oO0 )
 if ( iI == None ) :
  ooo0OOOoo += "{} {}" . format ( lisp . lisp_print_sans ( "Lookup not found for" ) ,
 lisp . lisp_print_cour ( eid_str ) )
 else :
  O0O0Oooo0o = lisp . lisp_print_elapsed ( iI . uptime )
  ooo0OOOoo += "{}{}{}{}{}{}" . format ( lisp . lisp_print_sans ( "{} match lookup for " . format ( "Exact" if OO0OO0O00oO0 else "Longest" ) ) ,
  # iII111i + oO0o - I1IiiI . ooOoO0o
  # Ii1I - O0 % oO0o * OOooOOo + I1IiiI
 lisp . lisp_print_cour ( eid_str ) ,
 lisp . lisp_print_sans ( " found " ) ,
 lisp . lisp_print_cour ( iI . print_eid_tuple ( ) ) ,
 lisp . lisp_print_sans ( ", referral-type {}" . format ( lisp . lisp_print_cour ( iI . print_referral_type ( ) ) ) ) ,
  # oO0o % ooOoO0o / I1Ii111 + iIii1I11I1II1 . OoooooooOO . I1IiiI
 lisp . lisp_print_sans ( " with uptime {}" . format ( lisp . lisp_print_cour ( O0O0Oooo0o ) ) ) )
  if 71 - 71: IiII * II111iiii * oO0o
  if 56 - 56: I1IiiI
 ooo0OOOoo += "<br>"
 return ( ooo0OOOoo )
 if 54 - 54: I1Ii111 / OOooOOo . oO0o % iII111i
 if 57 - 57: i11iIiiIii . I1ii11iIi11i - Ii1I - oO0o + OoOoOO00
 if 63 - 63: OoOoOO00 * iII111i
 if 69 - 69: O0 . OoO0O00
 if 49 - 49: I1IiiI - I11i
 if 74 - 74: iIii1I11I1II1 * I1ii11iIi11i + OoOoOO00 / i1IIi / II111iiii . Oo0Ooo
 if 62 - 62: OoooooooOO * I1IiiI
def oOOOoo0O0oO ( parameter ) :
 if 6 - 6: OOooOOo * o0oOOo0O0Ooo + iII111i
 if 44 - 44: Ii1I % OoO0O00 + OoooooooOO - O0 - Ii1I - II111iiii
 if 99 - 99: ooOoO0o . Ii1I + I1Ii111 + OoooooooOO % o0oOOo0O0Ooo
 if 51 - 51: iIii1I11I1II1
 if ( parameter != "" ) :
  return ( oOoooo0O0Oo ( parameter ) )
  if 34 - 34: oO0o + I1IiiI - oO0o
  if 17 - 17: II111iiii % iII111i + I11i - iII111i / OOooOOo + ooOoO0o
  if 59 - 59: OOooOOo % OoOoOO00 . Ii1I * I1ii11iIi11i % I11i
  if 59 - 59: oO0o - iII111i
  if 15 - 15: I1Ii111 . i11iIiiIii . OoooooooOO / OoO0O00 % Ii1I
 OooooOOoo0 = "Enter EID for Referral-Cache lookup:"
 i1I1IiiIi1i = lisp . lisp_eid_help_hover ( '<input type="text" name="eid" />' )
 if 29 - 29: I1IiiI % I1IiiI
 ooo0OOOoo = '''
        <form action="/lisp/show/referral/lookup" method="post">
        <i><font face="Courier New" size="3">
        {} {}
        <input style="background-color:transparent;border-radius:10px;" type="submit" value="Submit" />
        </font></i></form>
    ''' . format ( lisp . lisp_print_sans ( OooooOOoo0 ) , i1I1IiiIi1i )
 if 94 - 94: iIii1I11I1II1 / Oo0Ooo % iII111i * iII111i * II111iiii
 if 29 - 29: OoO0O00 + OoOoOO00 / o0oOOo0O0Ooo / OOooOOo * iIii1I11I1II1
 if 62 - 62: OOooOOo / oO0o - OoO0O00 . I11i
 if 11 - 11: I1ii11iIi11i . OoO0O00 * IiII * OoooooooOO + ooOoO0o
 IiII111i1i11 = len ( lisp . lisp_ddt_map_requestQ )
 if ( IiII111i1i11 != 0 ) :
  i111iIi1i1II1 = "{} entries in map-request queue" . format ( IiII111i1i11 )
  oooO = lisp . lisp_span ( "LISP-MR Map-Request Queue:" , i111iIi1i1II1 )
  if 26 - 26: Ii1I % I1ii11iIi11i
  ooo0OOOoo += lispconfig . lisp_table_header ( oooO ,
 "EID-Prefix or (S,G)" , "Nonce" , "Uptime" , "Map-Request Source" ,
 "Retry Count" , "Tried DDT-Root" , "Last Request Sent To" ,
 "Last Map-Referral EID-Prefix" )
  if 76 - 76: IiII * iII111i
  for ooooooo00o in lisp . lisp_ddt_map_requestQ :
   o0oooOO00 = lisp . lisp_ddt_map_requestQ [ ooooooo00o ]
   iiIiii1IIIII = lisp . lisp_print_elapsed ( o0oooOO00 . uptime )
   o00o = o0oooOO00 . last_request_sent_to
   o00o = "--" if ( o00o == None ) else o00o . print_address_no_iid ( )
   if 45 - 45: I1ii11iIi11i . o0oOOo0O0Ooo . I1ii11iIi11i - I1IiiI . o0oOOo0O0Ooo
   iiI1IIIi = o0oooOO00 . itr
   iiI1IIIi = "--" if ( iiI1IIIi == None ) else ( iiI1IIIi . print_address_no_iid ( ) + "<br>({}ITR)" . format ( "P" if o0oooOO00 . from_pitr else "" ) )
   if 47 - 47: Oo0Ooo % I11i % i11iIiiIii - O0 + ooOoO0o
   if 94 - 94: I1Ii111
   i11II1I11I1 = o0oooOO00 . last_cached_prefix [ 0 ]
   OOoOO0ooo = o0oooOO00 . last_cached_prefix [ 1 ]
   II1iIi11 = "--" if ( i11II1I11I1 == None ) else lisp . lisp_print_eid_tuple ( i11II1I11I1 , OOoOO0ooo )
   if 12 - 12: Ii1I + i11iIiiIii * iIii1I11I1II1 / I1ii11iIi11i . I11i
   if 5 - 5: i1IIi + IiII / o0oOOo0O0Ooo . iII111i / I11i
   ooo0OOOoo += lispconfig . lisp_table_row ( o0oooOO00 . print_eid_tuple ( ) ,
 "0x" + lisp . lisp_hex_string ( o0oooOO00 . nonce ) , iiIiii1IIIII , iiI1IIIi ,
 o0oooOO00 . retry_count , "yes" if o0oooOO00 . tried_root else "no" , o00o ,
 II1iIi11 )
   if 32 - 32: I1IiiI % iIii1I11I1II1 / i1IIi - I1IiiI
   if 7 - 7: I1Ii111 * OoO0O00 - ooOoO0o + OOooOOo * I1IiiI % OoO0O00
  ooo0OOOoo += lispconfig . lisp_table_footer ( )
  if 15 - 15: OoOoOO00 % I1IiiI * I11i
  if 81 - 81: ooOoO0o - iIii1I11I1II1 - i1IIi / I1Ii111 - O0 * I11i
 i111iIi1i1II1 = "{} entries in referral-cache" . format ( lisp . lisp_referral_cache . cache_size ( ) )
 if 20 - 20: oO0o % IiII
 oooO = lisp . lisp_span ( "LISP-MR Referral-Cache:" , i111iIi1i1II1 )
 if 19 - 19: I1ii11iIi11i % IiII + ooOoO0o / I1Ii111 . ooOoO0o
 ooo0OOOoo += lispconfig . lisp_table_header ( oooO ,
 "EID-Prefix or (S,G)" , "Uptime" , "Expires<br>TTL" ,
 "Referral Type" , "Map-Referral Source" ,
 "Referral Address<br>Node Status" ,
 "Priority<br>Weight" , "Map-Requests Sent<br>No Responses" )
 if 12 - 12: i1IIi + i1IIi - I1ii11iIi11i * Oo0Ooo % Oo0Ooo - II111iiii
 ooo0OOOoo = lisp . lisp_referral_cache . walk_cache ( o00oO0oOo00 ,
 ooo0OOOoo )
 if 52 - 52: ooOoO0o . iII111i + I1Ii111
 ooo0OOOoo += lispconfig . lisp_table_footer ( )
 return ( ooo0OOOoo )
 if 38 - 38: i1IIi - II111iiii . I1Ii111
 if 58 - 58: I1IiiI . iII111i + OoOoOO00
 if 66 - 66: iII111i / oO0o * OoooooooOO + OoooooooOO % I11i
 if 49 - 49: oO0o - i11iIiiIii . I1Ii111 * Ii1I % iII111i + i1IIi
 if 71 - 71: o0oOOo0O0Ooo
 if 38 - 38: oO0o % OoOoOO00 + I1ii11iIi11i . i11iIiiIii
 if 53 - 53: i11iIiiIii * iII111i
def OooooO0oOOOO ( referral , delete_list ) :
 if 100 - 100: iII111i % OOooOOo
 if ( referral . expires == 0 ) : return ( [ True , delete_list ] )
 if 86 - 86: Oo0Ooo . O0 - OoooooooOO . OoO0O00 + Ii1I
 OOo = lisp . lisp_get_timestamp ( )
 if ( referral . uptime + referral . referral_ttl > OOo ) :
  return ( [ True , delete_list ] )
  if 22 - 22: OoOoOO00 * O0 . IiII * i11iIiiIii - I1IiiI * ooOoO0o
  if 59 - 59: Oo0Ooo % OoooooooOO . iII111i / IiII + I1IiiI
  if 76 - 76: ooOoO0o
  if 73 - 73: O0 * iII111i + Ii1I + ooOoO0o
  if 40 - 40: II111iiii . OoOoOO00 * I1Ii111 + OOooOOo + OOooOOo
 I1ii1I1iiii = lisp . lisp_print_elapsed ( referral . uptime )
 iiI = referral . print_eid_tuple ( )
 lisp . lprint ( "Referral for EID-prefix {} has timed out, had uptime of {}" . format ( lisp . green ( iiI , False ) , I1ii1I1iiii ) )
 if 56 - 56: Oo0Ooo . I1ii11iIi11i . I1IiiI
 if 39 - 39: O0 + I1Ii111
 if 91 - 91: OoooooooOO - iIii1I11I1II1 + OoOoOO00 / OoO0O00 . OoOoOO00 + O0
 if 26 - 26: I1ii11iIi11i - OoooooooOO
 if 11 - 11: I1IiiI * oO0o
 delete_list . append ( referral )
 return ( [ True , delete_list ] )
 if 81 - 81: iII111i + IiII
 if 98 - 98: I1IiiI
 if 95 - 95: ooOoO0o / ooOoO0o
 if 30 - 30: I1ii11iIi11i + Oo0Ooo / Oo0Ooo % I1ii11iIi11i . I1ii11iIi11i
 if 55 - 55: ooOoO0o - I11i + II111iiii + iII111i % Ii1I
 if 41 - 41: i1IIi - I11i - Ii1I
 if 8 - 8: OoO0O00 + I1Ii111 - o0oOOo0O0Ooo % Oo0Ooo % o0oOOo0O0Ooo * oO0o
 if 9 - 9: Oo0Ooo - i11iIiiIii - OOooOOo * Ii1I + ooOoO0o
def iIIII ( ref , delete_list ) :
 if 45 - 45: I1ii11iIi11i % I1IiiI - i11iIiiIii
 if 11 - 11: iIii1I11I1II1 * iIii1I11I1II1 * I1IiiI
 if 46 - 46: OoOoOO00 + OoO0O00
 if 70 - 70: iII111i / iIii1I11I1II1
 if ( ref . group . is_null ( ) ) :
  return ( OooooO0oOOOO ( ref , delete_list ) )
  if 85 - 85: OoooooooOO % i1IIi * OoooooooOO / I1ii11iIi11i
  if 96 - 96: OoooooooOO + oO0o
 if ( ref . source_cache == None ) : return ( [ True , delete_list ] )
 if 44 - 44: oO0o
 if 20 - 20: I11i + Ii1I / O0 % iIii1I11I1II1
 if 88 - 88: OoOoOO00 / II111iiii
 if 87 - 87: I1ii11iIi11i - I1ii11iIi11i - iII111i + oO0o
 if 82 - 82: oO0o / iIii1I11I1II1 . I1IiiI . OOooOOo / o0oOOo0O0Ooo
 delete_list = ref . source_cache . walk_cache ( OooooO0oOOOO ,
 delete_list )
 return ( [ True , delete_list ] )
 if 42 - 42: Oo0Ooo
 if 19 - 19: oO0o % I1ii11iIi11i * iIii1I11I1II1 + I1IiiI
 if 46 - 46: Oo0Ooo
 if 1 - 1: iII111i
 if 97 - 97: OOooOOo + iII111i + O0 + i11iIiiIii
 if 77 - 77: o0oOOo0O0Ooo / OoooooooOO
 if 46 - 46: o0oOOo0O0Ooo % iIii1I11I1II1 . iII111i % iII111i + i11iIiiIii
 if 72 - 72: iIii1I11I1II1 * Ii1I % ooOoO0o / OoO0O00
def I11i1II ( ) :
 lisp . lisp_set_exception ( )
 Ooo = [ ]
 if 21 - 21: Oo0Ooo
 I1ii1 = lisp . lisp_referral_cache
 Ooo = I1ii1 . walk_cache ( iIIII , Ooo )
 if 99 - 99: ooOoO0o . I1Ii111 % IiII * IiII . i1IIi
 if 72 - 72: OOooOOo % I1ii11iIi11i + OoO0O00 / oO0o + IiII
 if 10 - 10: I1Ii111 / ooOoO0o + i11iIiiIii / Ii1I
 if 74 - 74: OOooOOo + O0 + i1IIi - i1IIi + II111iiii
 if 83 - 83: I1ii11iIi11i - I1IiiI + OOooOOo
 for OoooooOoo in Ooo : OoooooOoo . delete_cache ( )
 if 5 - 5: Ii1I
 if 46 - 46: IiII
 if 45 - 45: ooOoO0o
 if 21 - 21: oO0o . I1Ii111 . OOooOOo / Oo0Ooo / I1Ii111
 o00 = threading . Timer (
 lisp . LISP_REFERRAL_TIMEOUT_CHECK_INTERVAL , I11i1II ,
 [ ] )
 o00 . start ( )
 return
 if 17 - 17: OOooOOo / OOooOOo / I11i
 if 1 - 1: i1IIi . i11iIiiIii % OOooOOo
 if 82 - 82: iIii1I11I1II1 + Oo0Ooo . iIii1I11I1II1 % IiII / Ii1I . Ii1I
 if 14 - 14: o0oOOo0O0Ooo . OOooOOo . I11i + OoooooooOO - OOooOOo + IiII
 if 9 - 9: Ii1I
 if 59 - 59: I1IiiI * II111iiii . O0
 if 56 - 56: Ii1I - iII111i % I1IiiI - o0oOOo0O0Ooo
 if 51 - 51: O0 / ooOoO0o * iIii1I11I1II1 + I1ii11iIi11i + o0oOOo0O0Ooo
def Oo0OO0000oooo ( ) :
 global i1I1ii1II1iII
 global oooO0oo0oOOOO
 global o0oO0
 global O0oO
 if 7 - 7: oO0o - OoO0O00 - O0 % oO0o - II111iiii
 lisp . lisp_i_am ( "mr" )
 lisp . lisp_set_exception ( )
 lisp . lisp_print_banner ( "Map-Resolver starting up" )
 if 31 - 31: iII111i / Oo0Ooo - iII111i - OOooOOo
 if 7 - 7: iII111i % O0 . OoOoOO00 + I1IiiI - I11i
 if 75 - 75: I11i
 if 71 - 71: ooOoO0o
 if ( lisp . lisp_get_local_addresses ( ) == False ) : return ( False )
 if 53 - 53: OoooooooOO % Ii1I . IiII / i11iIiiIii % iII111i
 if 28 - 28: I11i
 if 58 - 58: OoOoOO00
 if 37 - 37: Oo0Ooo - iIii1I11I1II1 / I1ii11iIi11i
 o0oO0 = lisp . lisp_open_send_socket ( "lisp-mrms" , "" )
 oooO0oo0oOOOO = lisp . lisp_open_listen_socket ( "" , "lisp-mr" )
 oo0oOOo0 = "0.0.0.0" if lisp . lisp_is_raspbian ( ) else "0::0"
 O0oO = lisp . lisp_open_listen_socket ( oo0oOOo0 ,
 str ( Oo0oO0ooo ) )
 i1I1ii1II1iII [ 0 ] = O0oO
 i1I1ii1II1iII [ 1 ] = O0oO
 i1I1ii1II1iII [ 2 ] = oooO0oo0oOOOO
 if 86 - 86: I11i * I1IiiI + I11i + II111iiii
 if 8 - 8: I1Ii111 - iII111i / ooOoO0o
 if 96 - 96: OoOoOO00
 if 29 - 29: I1ii11iIi11i / i1IIi . I1IiiI - OoOoOO00 - OoOoOO00 - Ii1I
 o00 = threading . Timer (
 lisp . LISP_REFERRAL_TIMEOUT_CHECK_INTERVAL , I11i1II ,
 [ ] )
 o00 . start ( )
 return ( True )
 if 20 - 20: i1IIi % OoO0O00 . I1IiiI / IiII * i11iIiiIii * OOooOOo
 if 85 - 85: o0oOOo0O0Ooo . OoOoOO00 / ooOoO0o . O0 % I1Ii111
 if 90 - 90: Oo0Ooo % O0 * iIii1I11I1II1 . iII111i
 if 8 - 8: ooOoO0o + II111iiii / iII111i / I11i
 if 74 - 74: O0 / i1IIi
 if 78 - 78: OoooooooOO . OoO0O00 + ooOoO0o - i1IIi
 if 31 - 31: OoooooooOO . OOooOOo
def O0iII1 ( ) :
 if 27 - 27: OoO0O00 . I11i + OoOoOO00 / iIii1I11I1II1 % iII111i . ooOoO0o
 if 14 - 14: oO0o + I1ii11iIi11i - iII111i / O0 . I1Ii111
 if 45 - 45: I1Ii111
 if 83 - 83: OoOoOO00 . OoooooooOO
 lisp . lisp_close_socket ( O0oO , "" )
 lisp . lisp_close_socket ( o0oO0 , "lisp-mrms" )
 lisp . lisp_close_socket ( oooO0oo0oOOOO , "lisp-mr" )
 return
 if 58 - 58: i11iIiiIii + OoooooooOO % OoooooooOO / IiII / i11iIiiIii
 if 62 - 62: OoO0O00 / I1ii11iIi11i
 if 7 - 7: OoooooooOO . IiII
 if 53 - 53: Ii1I % Ii1I * o0oOOo0O0Ooo + OoOoOO00
 if 92 - 92: OoooooooOO + i1IIi / Ii1I * O0
 if 100 - 100: ooOoO0o % iIii1I11I1II1 * II111iiii - iII111i
 if 92 - 92: ooOoO0o
def II11iI111i1 ( packet , source_str , sport ) :
 if 95 - 95: OoooooooOO - IiII * I1IiiI + OoOoOO00
 iIi1 = lisp . lisp_control_header ( )
 if ( iIi1 . decode ( packet ) == None ) :
  lisp . lprint ( "Could not decode control header" )
  return
  if 21 - 21: I11i
  if 92 - 92: i11iIiiIii / I1Ii111 - iII111i % ooOoO0o * I1Ii111 + Oo0Ooo
  if 11 - 11: OoooooooOO . I1Ii111
  if 80 - 80: OoooooooOO - OOooOOo * Ii1I * I1ii11iIi11i / I1IiiI / OOooOOo
  if 13 - 13: I1Ii111 * ooOoO0o + i11iIiiIii * I1Ii111 - ooOoO0o
 Ii1i1i1i1I1Ii = lisp . lisp_address ( lisp . LISP_AFI_NONE , "" , 0 , 0 )
 Ii1i1i1i1I1Ii . store_address ( source_str )
 if 25 - 25: II111iiii
 if 11 - 11: Oo0Ooo
 if 74 - 74: OoOoOO00 * o0oOOo0O0Ooo + OoOoOO00 . OOooOOo * OoooooooOO % O0
 if 85 - 85: ooOoO0o / O0
 if 18 - 18: o0oOOo0O0Ooo % O0 * I1ii11iIi11i
 if 62 - 62: I1Ii111 . IiII . OoooooooOO
 if ( iIi1 . type == lisp . LISP_ECM ) :
  i111 = ( len ( oo00 ) > 0 )
  if ( lisp . lisp_is_running ( "lisp-ms" ) and i111 == False ) :
   packet = lisp . lisp_packet_ipc ( packet , source_str , sport )
   lisp . lisp_ipc ( packet , o0oO0 , "lisp-ms" )
   return
   if 27 - 27: i11iIiiIii / I1ii11iIi11i
   if 84 - 84: Oo0Ooo
   if 43 - 43: oO0o - OoooooooOO
   if 3 - 3: O0 / iII111i
   if 31 - 31: OOooOOo + o0oOOo0O0Ooo . OoooooooOO
  if ( i111 ) :
   lisp . lisp_process_ecm ( i1I1ii1II1iII , packet , Ii1i1i1i1I1Ii , sport )
   return
   if 89 - 89: II111iiii + i1IIi + II111iiii
  lisp . lprint ( "Map-Resolver dropping ECM, DDT or Map-Server not " + "configured" )
  if 7 - 7: O0 % o0oOOo0O0Ooo + I1ii11iIi11i * iII111i - iII111i
  return
  if 42 - 42: OoOoOO00 * OoOoOO00 * I1Ii111 . I11i
  if 51 - 51: OOooOOo % iIii1I11I1II1 - OoooooooOO % ooOoO0o * iIii1I11I1II1 % OoO0O00
  if 99 - 99: oO0o * II111iiii * I1Ii111
  if 92 - 92: Oo0Ooo
  if 40 - 40: OoOoOO00 / IiII
 if ( iIi1 . type == lisp . LISP_MAP_REFERRAL ) :
  lisp . lisp_process_map_referral ( i1I1ii1II1iII , packet , Ii1i1i1i1I1Ii )
  return
  if 79 - 79: OoO0O00 - iIii1I11I1II1 + Ii1I - I1Ii111
  if 93 - 93: II111iiii . I1IiiI - Oo0Ooo + OoOoOO00
  if 61 - 61: II111iiii
  if 15 - 15: i11iIiiIii % I1IiiI * I11i / I1Ii111
  if 90 - 90: iII111i
 lisp . lprint ( "Map-Resolver received an unexpected LISP packet, type: {}" . format ( iIi1 . type ) )
 if 31 - 31: OOooOOo + O0
 return
 if 87 - 87: ooOoO0o
 if 45 - 45: OoO0O00 / OoooooooOO - iII111i / Ii1I % IiII
 if 83 - 83: I1IiiI . iIii1I11I1II1 - IiII * i11iIiiIii
 if 20 - 20: i1IIi * I1Ii111 + II111iiii % o0oOOo0O0Ooo % oO0o
 if 13 - 13: Oo0Ooo
 if 60 - 60: I1ii11iIi11i * I1IiiI
 if 17 - 17: OOooOOo % Oo0Ooo / I1ii11iIi11i . IiII * OOooOOo - II111iiii
i1i1IIii1i1 = {
 "lisp ddt-root" : [ oOOOO , {
 "address" : [ False ] ,
 "public-key" : [ False ] ,
 "priority" : [ False , 0 , 255 ] ,
 "weight" : [ False , 0 , 100 ] } ] ,

 "lisp referral-cache" : [ II1i1IiiIIi11 , {
 "prefix" : [ ] ,
 "instance-id" : [ True , 0 , 0xffffffff ] ,
 "eid-prefix" : [ True ] ,
 "group-prefix" : [ True ] ,
 "referral" : [ ] ,
 "address" : [ True ] ,
 "priority" : [ True , 0 , 255 ] ,
 "weight" : [ True , 0 , 100 ] } ] ,

 "show referral-cache" : [ oOOOoo0O0oO , { } ] ,
 }
if 65 - 65: I1IiiI + OoOoOO00 / OOooOOo
if 83 - 83: o0oOOo0O0Ooo . iII111i - Oo0Ooo
if 65 - 65: iIii1I11I1II1 / ooOoO0o . IiII - II111iiii
if 72 - 72: iIii1I11I1II1 / IiII % iII111i % OOooOOo - I11i % OOooOOo
if 100 - 100: Oo0Ooo + i11iIiiIii
if 71 - 71: I11i / o0oOOo0O0Ooo / I1Ii111 % OOooOOo
if ( Oo0OO0000oooo ( ) == False ) :
 lisp . lprint ( "lisp_mr_startup() failed" )
 lisp . lisp_print_banner ( "Map-Resolver abnormal exit" )
 exit ( 1 )
 if 51 - 51: IiII * O0 / II111iiii . Ii1I % OOooOOo / I1IiiI
 if 9 - 9: I1IiiI % I1IiiI % II111iiii
I1I1i1I = [ O0oO , oooO0oo0oOOOO ]
oo0oo = [ O0oO ] * 3
if 41 - 41: OoOoOO00 * I11i / OoOoOO00 % oO0o
while ( True ) :
 try : Ii , oO0oOOO0Ooo , i1i1I = select . select ( I1I1i1I , [ ] , [ ] )
 except : break
 if 25 - 25: iIii1I11I1II1 + I1ii11iIi11i + iII111i / II111iiii / I11i
 if ( O0oO in Ii ) :
  o0O0Oo00Oo0o , Ii1i1i1i1I1Ii , OOOo , oo0OOo0O = lisp . lisp_receive ( oo0oo [ 0 ] ,
 False )
  if ( Ii1i1i1i1I1Ii == "" ) : break
  lisp . lisp_parse_packet ( oo0oo , oo0OOo0O , Ii1i1i1i1I1Ii , OOOo )
  continue
  if 39 - 39: OoooooooOO + oO0o % OOooOOo / OOooOOo
  if 27 - 27: iII111i . I11i . iIii1I11I1II1 . iIii1I11I1II1
 o0O0Oo00Oo0o , Ii1i1i1i1I1Ii , OOOo , oo0OOo0O = lisp . lisp_receive ( oooO0oo0oOOOO , True )
 if 20 - 20: o0oOOo0O0Ooo / i1IIi
 if ( Ii1i1i1i1I1Ii == "" ) : break
 if 71 - 71: OoOoOO00 . i1IIi
 if ( o0O0Oo00Oo0o == "command" ) :
  oo0OOo0O = oo0OOo0O . decode ( )
  if ( oo0OOo0O == "clear" ) :
   oo ( )
   continue
   if 94 - 94: OOooOOo . I1Ii111
  lispconfig . lisp_process_command ( oooO0oo0oOOOO , o0O0Oo00Oo0o ,
 oo0OOo0O , "lisp-mr" , [ i1i1IIii1i1 ] )
 else :
  II11iI111i1 ( oo0OOo0O , Ii1i1i1i1I1Ii , OOOo )
  if 84 - 84: O0 . I11i - II111iiii . ooOoO0o / II111iiii
  if 47 - 47: OoooooooOO
  if 4 - 4: I1IiiI % I11i
O0iII1 ( )
lisp . lisp_print_banner ( "Map-Resolver normal exit" )
exit ( 0 )
if 10 - 10: IiII . OoooooooOO - OoO0O00 + IiII - O0
if 82 - 82: ooOoO0o + II111iiii
if 39 - 39: oO0o % iIii1I11I1II1 % O0 % OoooooooOO * I1ii11iIi11i + iII111i
# dd678faae9ac167bc83abf78e5cb2f3f0688d3a3
